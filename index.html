<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml" lang="en"><head profile="http://gmpg.org/xfn/11">


	<title> Snax</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="index_files/style.css" type="text/css" media="screen">
	<link rel="pingback" href="http://evanweaver.wordpress.com/xmlrpc.php">
		<link rel="alternate" type="application/rss+xml" title="Snax » Feed" href="http://evanweaver.wordpress.com/feed/">
<link rel="alternate" type="application/rss+xml" title="Snax » Comments Feed" href="http://evanweaver.wordpress.com/comments/feed/">
<script type="text/javascript">
/* <![CDATA[ */
function addLoadEvent(func){var oldonload=window.onload;if(typeof window.onload!='function'){window.onload=func;}else{window.onload=function(){oldonload();func();}}}
/* ]]> */
</script>
<link rel="stylesheet" href="index_files/global.css" type="text/css">
<script type="text/javascript" src="index_files/l10n.js"></script>
<script type="text/javascript" src="index_files/jquery.js"></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://evanweaver.wordpress.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://evanweaver.wordpress.com/wp-includes/wlwmanifest.xml"> 
<link rel="index" title="Snax" href="http://evanweaver.wordpress.com/">
<meta name="generator" content="WordPress.com">
<link rel="shortlink" href="http://wp.me/1dOab">
<link rel="shortcut icon" type="image/x-icon" href="http://s1.wp.com/i/favicon-stacked.ico?m=1290883291g" sizes="16x16 24x24 32x32 48x48">
<link rel="icon" type="image/x-icon" href="http://s1.wp.com/i/favicon-stacked.ico?m=1290883291g" sizes="16x16 24x24 32x32 48x48">
<link rel="apple-touch-icon" href="http://s0.wp.com/wp-content/themes/h4/i/webclip.png?m=1290883317g">
	<style type="text/css">
	/* <![CDATA[ */
				div#likes { margin-top: 15px; }
		.like-button { border: 1px solid #eee; padding: 2px 6px; font-size: 13px; font-family: arial, tahoma, sans-serif; }
		#wpl-likebox { clear: left; font-size: 11px; font-family: arial, tahoma, verdana, sans-serif !important; min-height: 30px; margin: 10px 0 !important; padding: 5px 0 10px 0 !important; }
		#wpl-button { float: left; background: url( /i/buttonbg.png ) top left repeat-x; margin-right: 7px; border: 1px solid #d4d4d4; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }
		#wpl-button a { color: #666 !important; line-height: 130% !important; text-decoration: none !important; outline: none; float: left; padding: 3px 6px 2px 24px !important; font-size: 11px !important; background: url( /i/likestar.png ) 6px 49.8% no-repeat; }
		#wpl-button.liked { background: #feffce; border: 1px solid #f3e389; }
		#wpl-button.liked a { color: #ba871b !important; }
		#wpl-likebox #wpl-count { min-height: 25px; line-height: 130% !important; float: left; padding-top: 4px; }
		#wpl-likebox #wpl-avatars { clear: left; max-height: 98px; overflow: hidden; margin-top: 15px; line-height: 130% !important; }
		#wpl-likebox #wpl-avatars img { border: none !important; }
		#wpl-likebox #wpl-mustlogin { line-height: 14px !important; font-size: 11px; clear: left; margin-top: 5px; background: #f0f0f0; padding: 10px; width: 65%; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }
		#wpl-likebox #wpl-mustlogin a { color: #888; text-decoration: underline; }
		#wpl-likebox #wpl-mustlogin p { margin: 5px 0; padding: 0 }
		#wpl-likebox #wpl-mustlogin input.input { padding: 2px; background: #fff; font-size: 11px; font-family: inherit; border: 1px solid #ccc; -moz-box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1) inset; -webkit-box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1) inset; line-height: 12px; }
		#wpl-likebox #wpl-mustlogin input#wp-submit { border: 1px solid #ccc; font-size: 11px; background: #fafafa; repeat-x; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; padding: 2px 4px !important; line-height: 12px; }
		#wpl-likebox #wpl-mustlogin label { position: relative; cursor: text; }
		#wpl-likebox #wpl-mustlogin label span { position: absolute; top: 0px; left: 5px; padding: 0 !important; }
		#wpl-likebox #wpl-mustlogin label span { top /*\**/: -10px\9; }
	/* ]]> */
	</style>
	<link rel="openid.server" href="http://evanweaver.wordpress.com/?openidserver=1">
<link rel="openid.delegate" href="http://evanweaver.wordpress.com/">
<link rel="search" type="application/opensearchdescription+xml" href="http://evanweaver.wordpress.com/osd.xml" title="Snax">
<link rel="search" type="application/opensearchdescription+xml" href="http://wordpress.com/opensearch.xml" title="WordPress.com">
<meta name="application-name" content="Snax"><meta name="msapplication-window" content="width=device-width;height=device-height"><meta name="msapplication-tooltip" content="a big website blog"><meta name="msapplication-task" content="name=Subscribe;action-uri=http://evanweaver.wordpress.com/feed/;icon-uri=http://s1.wp.com/i/favicon-stacked.ico"><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=http://s2.wp.com/i/favicon.ico"><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=http://s2.wp.com/i/favicon.ico"><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=http://s2.wp.com/i/favicon.ico"><link rel="stylesheet" type="text/css" id="gravatar-card-css" href="index_files/hovercard.css"><link rel="stylesheet" type="text/css" id="gravatar-card-services-css" href="index_files/services.css"></head><body class="wordpress y2010 m12 d03 h00 home blog">

<div id="wrapper" class="hfeed">

	<div id="header">
		<h1 id="blog-title"><span><a href="http://evanweaver.wordpress.com/" title="Snax" rel="home">Snax</a></span></h1>
		<div id="blog-description">a big website blog</div>
	</div><!--  #header -->

	<div id="access">
		<div class="skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
		<div id="menu"><ul><li class="page_item page-item-2"><a href="http://evanweaver.wordpress.com/about/" title="About">About</a></li></ul></div>
	</div><!-- #access -->

	<div id="container">
		<div id="content">

			<div id="nav-above" class="navigation">
				<div class="nav-previous"><a href="http://evanweaver.wordpress.com/page/2/"><span class="meta-nav">«</span> Older posts</a></div>
				<div class="nav-next"></div>
			</div>


			<div id="post-296" class="hentry p1 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/distributed-systems-primer-update-2/" title="Permalink to distributed systems primer,&nbsp;updated" rel="bookmark">distributed systems primer,&nbsp;updated</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:51:10-0800">November 30, 2010 – 2:51 AM</abbr></div>
				<div class="entry-content">
<p>Well, it’s been a long time. But! I have four papers to add to my original <a href="http://blog.evanweaver.com/articles/2009/05/04/distributed-systems-primer/">distributed systems primer</a>:</p>
<h2>coordination</h2>
<p style="margin-bottom: 2px;"><a href="http://pagesperso-systeme.lip6.fr/Marc.Shapiro/papers/RR-6956.pdf">CRDTs: Consistency Without Concurrency Control</a>, Mihai Letia, Nuno Preguiça, and Marc Shapiro, 2009.</p>
<p>Guaranteeing eventual consistency by constraining your data structure, rather than adding heavyweight distributed algorithms. <a href="http://github.com/twitter/flockdb">FlockDB</a> works this way.</p>
<h2>partitioning</h2>
<p style="margin-bottom: 2px;"><a href="http://www.cscs.umich.edu/%7Ejmpujol/public/papers/scaling_sn_netdb.pdf">Scaling Online Social Networks Without Pains</a>, Josep M. Pujol, Georgos Siganos, Vijay Erramilli, and Pablo Rodriguez, 2010.</p>
<p>Optimally partitioning overlapping graphs through lazy replication. 
Think of applying this technique at a cluster level, not just a server 
level.</p>
<p>There’s a better version of this paper titled “The Little Engines 
That Could”; I’ll update the post when it’s generally available.</p>
<p style="margin-bottom: 2px;"><a href="http://research.yahoo.com/files/sigmod278-silberstein.pdf">Feeding Frenzy: Selectively Materializing Users’ Event Feeds</a>, Adam Silberstein, Jeff Terrace, Brian F. Cooper, and Raghu Ramakrishnan, 2010.</p>
<p>Judicious session management and application of domain knowledge 
allow for optimal high-velocity mailbox updates in a memory grid. 
Twitter’s timeline system works this way.</p>
<h2>systems integration</h2>
<p style="margin-bottom: 2px;"><a href="http://static.googleusercontent.com/external_content/untrusted_dlcp/research.google.com/en/us/archive/papers/dapper-2010-1.pdf">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a>,
 Benjamin H. Sigelman, Luiz André Barroso, Mike Burrows, Pat Stephenson,
 Manoj Plakal, Donald Beaver, Saul Jaspan, and Chandan Shanbhag, 2010.</p>
<p>Add a transaction-tracking, sampling profiler to a reusable RPC 
framework and get full stack visibility without performance degradation.</p>
<p>Happy scaling. Make sure to read the <a href="http://blog.evanweaver.com/articles/2009/05/04/distributed-systems-primer/">original post</a> if you haven’t.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><span>Comments Off</span></span>
				</div>
			</div><!-- .post -->



			<div id="post-295" class="hentry p2 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18 alt">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/object-allocations-on-the-web-2/" title="Permalink to object allocations on the&nbsp;web" rel="bookmark">object allocations on the&nbsp;web</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:51:09-0800">November 30, 2010 – 2:51 AM</abbr></div>
				<div class="entry-content">
<p>How many objects does a Rails request allocate? Here are Twitter’s numbers:</p>
<ul>
<li><b>API</b>: 22,700 objects per request</li>
<li><b>Website</b>: 67,500 objects per request </li>
<li><b>Daemons</b>: 27,900 objects per action</li>
</ul>
<p>I want them to be lower. Overall, we burn 20% of our front-end CPU on
 garbage collection, which seems high. Each process handles ~29,000 
requests before getting killed by the memory limit, and the GC is 
triggered about every 30 requests.</p>
<p>In memory-managed languages, you pay a performance penalty at object 
allocation time and also at collection time. Since Ruby lacks a 
generational GC (although there are <a href="http://github.com/authorNari/patch_bag/blob/master/ruby/gc_partial_longlife_r23386.patch">patches</a> available), the collection penalty is linear with the number of objects on the heap.</p>
<h2>a note about structs and immediates</h2>
<p>In Ruby 1.8, <code>Struct</code> instances <a href="http://eigenclass.org/R2/writings/object-size-ruby-ocaml">use fewer bytes</a> and allocate less objects than<br>
<code>Hash</code> and friends. This can be an optimization opportunity in circumstances where the <code>Struct</code> class is reusable.</p>
<p>A little bit of code shows the difference (you need <a href="http://www.rubyenterpriseedition.com/">REE</a> or Sylvain Joyeux’s <a href="http://rubyforge.org/tracker/download.php/426/1700/11497/2087/ruby-track-alloc.patch">patch</a> to track allocations):</p>
<pre>GC.enable_stats
def sizeof(obj)
  GC.clear_stats
  obj.clone
  puts "#{GC.num_allocations} allocations"
  GC.clear_stats
  obj.clone
  puts "#{GC.allocated_size} bytes"
end
</pre>
<p>Let’s try it:</p>
<pre>&gt;&gt; Struct.new("Test", :a, :b, :c)
&gt;&gt; struct = Struct::Test.new(1,2,3)
=&gt; #&lt;struct Struct::Test a=1, b=2, c=3&gt;
&gt;&gt; sizeof(struct)
1 allocations
24 bytes

&gt;&gt; hash = {:a =&gt; 1, :b =&gt; 2, :c =&gt; 3}
&gt;&gt; sizeof(hash)
5 allocations
208 bytes
</pre>
<p>Watch out, though. The <code>Struct</code> class itself is expensive:</p>
<pre>&gt;&gt; sizeof(Struct::Test)
29 allocations
1216 bytes
</pre>
<p>In my understanding, each key in a <code>Hash</code> is a <code>VALUE</code> pointer to another object, while each slot in a <code>Struct</code> is merely a named position.</p>
<p>Immediate types (<code>Fixnum</code>, <code>nil</code>, <code>true</code>, <code>false</code>, and <code>Symbol</code>) don’t allocate, except for <code>Symbol</code>. <code>Symbol</code> is interned and keeps its string representations on a special heap that is not garbage-collected.</p>
<h2>your turn</h2>
<p>If you have allocation counts from a production web application, I 
would be delighted to know them. I am especially interested in Python, 
PHP, and Java.</p>
<p>Python should be about the same as Ruby. PHP, though, discards the 
entire heap per-request in some configurations, so collection can be<br>
dramatically cheaper. And I would expect Java to allocate fewer objects and have a more efficient collection cycle.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/object-allocations-on-the-web-2/#comments" title="Comment on object allocations on the&nbsp;web">Comments (6)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-294" class="hentry p3 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/scribe-client-gem-2/" title="Permalink to scribe&nbsp;client" rel="bookmark">scribe&nbsp;client</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:51:08-0800">November 30, 2010 – 2:51 AM</abbr></div>
				<div class="entry-content">
<p>I’ve released Scribe 0.1, a Ruby client for the <a href="http://sourceforge.net/apps/mediawiki/scribeserver/index.php?title=Main_Page">Scribe</a><br>
remote log server.</p>
<pre>sudo gem install scribe</pre>
<p>Usage is simple:</p>
<pre>client = Scribe.new
client.log("I'm lonely in a crowded room.", "Rails")
</pre>
<p>Documentation is <a href="http://blog.evanweaver.com/files/doc/fauna/scribe/files/README.html">here</a>.</p>
<h2>about scribe</h2>
<p>The primary benefit of Scribe over something like <a href="http://www.balabit.com/network-security/syslog-ng/">syslog-ng</a> is<br>
increased scalability, because of Scribe’s fundamentally distributed architecture. Scribe also does away with the legacy<br>
<code>syslog</code><br>
alert levels, and lets you define more application-appropriate categories on the fly instead.</p>
<p>Dmytro Shteflyuk has <a href="http://kpumuk.info/development/installing-and-using-scribe-with-ruby-on-mac-os/">good article</a> about installing the Scribe<br>
server itself on OS X. It would be nice if someone would put it in MacPorts, but it may be blocked on the<br>
release of Thrift.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/scribe-client-gem-2/#comments" title="Comment on scribe&nbsp;client">Comments (3)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-293" class="hentry p4 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18 alt">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/ree-2/" title="Permalink to ree" rel="bookmark">ree</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:51:04-0800">November 30, 2010 – 2:51 AM</abbr></div>
				<div class="entry-content">
<p>We recently migrated Twitter from a custom Ruby 1.8.6 build to a <a href="http://www.rubyenterpriseedition.com/">Ruby Enterprise Edition</a> release candidate, courtesy of <a href="http://www.phusion.nl/">Phusion</a>. Our primary motivation was the integration of Brent’s <a href="http://github.com/brentr/matzruby/tree/v1_8_7_72-mbari">MBARI patches</a>, which increase memory stability.</p>
<p>Some features of REE have no effect on our codebase, but we 
definitely benefit from the MBARI patchset, the Railsbench tunable GC, 
and the various leak fixes in 1.8.7p174. These are difficult to 
integrate and Phusion has done a fine job.</p>
<h2>testing notes</h2>
<p>I ran into an interesting issue. Ruby is faster if compiled with <code>-Os</code> (optimize for size) than with <code>-O2</code> or <code>-O3</code>
 (optimize for speed). Hongli pointed out that Ruby has poor instruction
 locality and benefits most from squeezing tightly into the instruction 
cache. This is an unusual phenomenon, although probably more common in 
interpreters and virtual machines than in “standard” C programs.</p>
<p>I also tested a build that included Joe Damato’s <a href="http://timetobleed.com/fixing-threads-in-ruby-18-a-2-10x-performance-boost/">heaped thread frames</a>, but it would hang Mongrel in <code>rb_thread_schedule()</code> after the first GC run, which is not exactly what we want. Hopefully this can be integrated later.</p>
<h2>benchmarks</h2>
<p>I ran a suite of benchmarks via <a href="http://www.xenoclast.org/autobench/">Autobench/httperf</a> and plotted them with <a href="http://plot.micw.eu/">Plot</a>.
 The hardware was a 4-core Xeon machine with RHEL5, running 8 Mongrels 
balanced behind Apache 2.2. I made a typical API request that is 
answered primarily from composed caches.</p>
<div style="margin: 0pt; padding: 0pt;"><img src="index_files/ree_benchmark.png"></div>
<p>As usual, we see that <a href="http://blog.evanweaver.com/articles/2009/04/09/ruby-gc-tuning/">tuning the GC parameters</a>
 has the greatest impact on throughput, but there is a definite gain 
from switching to the REE bundle. It’s also interesting how much the 
standard deviation is improved by the GC settings. (Some data points are
 skipped due to errors at high concurrency.)</p>
<h2>upgrading</h2>
<p>Moving from 1.8.6 to REE 1.8.7 was trivial, but moving to 1.9 will be
 more of an ordeal. It will be interesting to see what patches are still
 necessary on 1.9. Many of them are getting upstreamed, but some things 
(such as <a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html">tcmalloc</a>) will probably remain only available from 3rd parties.</p>
<p>All in all, good times in MRI land.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/ree-2/#comments" title="Comment on ree">Comments (24)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-292" class="hentry p5 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/memcached-gem-release-2/" title="Permalink to memcached gem&nbsp;release" rel="bookmark">memcached gem&nbsp;release</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:51:02-0800">November 30, 2010 – 2:51 AM</abbr></div>
				<div class="entry-content">
<p>One of the hardest gems to install is no more. It’s now easy to install!</p>
<p><a href="http://blog.evanweaver.com/files/doc/fauna/memcached">Memcached 0.15</a> features:</p>
<ul>
<li>Update to libmemcached 0.31.1</li>
<li>Bundle libmemcached itself with the gem (<a href="http://github.com/antifuchs">antifuchs</a>)</li>
<li>UDP connection support</li>
<li>Unix domain socket support (<a href="http://github.com/hellvinz/">hellvinz</a>)</li>
<li><code>AUTO_EJECT_HOSTS</code> bugfixes (<a href="http://github.com/mattknox">mattknox</a>)</li>
</ul>
<p>Install with <code>gem install memcached</code>. Since <a href="http://tangent.org/552/libmemcached.html">libmemcached</a> is bundled in, there are no longer any dependencies.</p>
<h2>on coordination</h2>
<p><a href="http://github.com/antifuchs">Andreas Fuchs</a> suggested several months ago that I include libmemcached itself in the gem, but at the time I resisted. I was wrong.</p>
<p>My opposition was based on the idea that libmemcached itself would be
 an integration point, so running multiple versions on a system would be
 bad.</p>
<p>In real life, the hash algorithm became the integration point, not 
the library itself. And since the library’s ABI kept changing, the gem 
always required a very specific custom build. This annoyed the public 
and caused extra work for my operations team, who had to make sure to 
upgrade both the library and the gem at the same time.</p>
<p>Updates can come thick and fast now because I don’t have to worry 
about publishing custom builds or waiting for the libmemcached 
developers to merge my patches.</p>
<p>In retrospect it seems obvious—it’s always a win to remove coordination from a system.</p>
<h2>linker woes</h2>
<p>Unfortunately, it was easier to make that decision than it was to 
implement it. Linux and OS X link libraries differently, and I had a lot
 of trouble making sure that no system-installed version of libmemcached
 would get linked, instead of the custom one built during <code>gem install</code>.</p>
<p>When you link a shared object, OS X seems to maintain a reference to the original <code>.dylib</code>. Linux does not, and depends on ldconfig and <code>LD_LIBRARY_PRELOAD</code>
 to find the object at runtime. Since you can’t modify the shell 
environment from within a running process, there’s no way to override <code>LD_LIBRARY_PRELOAD</code>, so I needed to statically link libmemcached into the gem’s own <code>.so</code> or <code>.bundle</code>.</p>
<p>The only way I could do this on both systems was to configure libmemcached with <code>CFLAGS=-fPIC --disable-shared</code>, rename the <code>libemcached.*</code> static object files to <code>libemcached_gem.*</code>, and pass <code>-lmemcached_gem</code> to the linker rather than <code>-lmemcached</code>. Otherwise the linker would prefer the system-installed dynamic objects, even with the correct paths and <code>-static</code> option set.</p>
<p>Note that you can check what objects a binary has linked to via <code>otool -F</code> on OS X, and <code>ldd</code> on Linux.</p>
<p>Feel free to look at the <a href="http://github.com/fauna/memcached/blob/6f2c517df97a5a6c871802d93ef56fdb4358c22c/ext/extconf.rb">extconf.rb source</a> and let me know if there’s a better way to do this.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/memcached-gem-release-2/#comments" title="Comment on memcached gem&nbsp;release">Comments (15)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-291" class="hentry p6 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18 alt">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/up-and-running-with-cassandra-2/" title="Permalink to up and running with&nbsp;cassandra" rel="bookmark">up and running with&nbsp;cassandra</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:50:58-0800">November 30, 2010 – 2:50 AM</abbr></div>
				<div class="entry-content">
<p><a href="http://wiki.apache.org/cassandra/">Cassandra</a> is a hybrid non-relational database in the same class as Google’s BigTable. It is more featureful<br>
than a key/value store like <a href="http://www.basho.com/Riak.html">Riak</a>, but supports fewer query types than a document store like <a href="http://www.mongodb.org/">MongoDB</a>.</p>
<p>Cassandra was started by Facebook and later transferred to the 
open-source community. It is an ideal runtime database for web-scale 
domains like social networks.</p>
<p>This post is both a tutorial and a “getting started” overview. You 
will learn about Cassandra’s features, data model, API, and operational 
requirements—everything you need to know to deploy a Cassandra-backed 
service.</p>
<p><b>May 11, 2010</b>: post updated for Cassandra gem 0.8 and Cassandra version 0.6.</p>
<h2>features</h2>
<p>There are a number of reasons to choose Cassandra for your website. Compared to other databases, three big features stand out:</p>
<ul>
<li><b>Flexible schema</b>: with Cassandra, like a document store, you 
don’t have to decide what fields you need in your records ahead of time.
 You can add and remove arbitrary fields on the fly. This is an 
incredible productivity boost, especially in large deployments.</li>
<li><b>True scalability</b>: Cassandra scales horizontally in the purest
 sense. To add more capacity to a cluster, turn on another machine. You 
don’t have restart any processes, change your application queries, or 
manually relocate any data.</li>
<li><b>Multi-datacenter awareness</b>: you can adjust your node layout 
to ensure that if one datacenter burns in a fire, an alternative 
datacenter will have at least one full copy of every record.</li>
</ul>
<p>Some other features that help put Cassandra above the competition<br>
:</p>
<ul>
<li><b>Range queries</b>: unlike most key/value stores, you can query for ordered ranges of keys.</li>
<li><b>List datastructures</b>: super columns add a 5th dimension to the
 hybrid model, turning columns into lists. This is very handy for things
 like per-user indexes.</li>
<li><b>Distributed writes</b>: you can read and write any data to anywhere in the cluster at any time. There is never any single point of failure.</li>
</ul>
<h2>installation</h2>
<p>You need a Unix system. If you are using Mac OS 10.5, all you need is
 Git. Otherwise, you need to install Java 1.6, Git 1.6, Ruby, and 
Rubygems in some reasonable way.</p>
<p>Start a terminal and run:</p>
<pre>sudo gem install cassandra
</pre>
<p>If you are using Mac OS, you need to export the following environment variables:</p>
<pre>export JAVA_HOME="/System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home"
export PATH="/System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home/bin:$PATH"
</pre>
<p>Now you can build and start a test server with <code>cassandra_helper</code>:</p>
<pre>cassandra_helper cassandra
</pre>
<p>It runs!</p>
<h2>live demo</h2>
<p>The above script boots the server with a schema that we can interact with. Open another terminal window and start <code>irb</code>, the Ruby shell:</p>
<pre>irb
</pre>
<p>In the <code>irb</code> prompt, require the library:</p>
<pre>require 'rubygems'
require 'cassandra'
include SimpleUUID
</pre>
<p>Now instantiate a client object:</p>
<pre>twitter = Cassandra.new('Twitter')
</pre>
<p>Let’s insert a few things:</p>
<pre>user = {'screen_name' =&gt; 'buttonscat'}
twitter.insert(:Users, '5', user)

tweet1 = {'text' =&gt; 'Nom nom nom nom nom.', 'user_id' =&gt; '5'}
twitter.insert(:Statuses, '1', tweet1)

tweet2 = {'text' =&gt; '@evan Zzzz....', 'user_id' =&gt; '5', 'reply_to_id' =&gt; '8'}
twitter.insert(:Statuses, '2', tweet2)
</pre>
<p>Notice that the two status records do not have all the same columns. Let’s go ahead and connect them to our user record:</p>
<pre>twitter.insert(:UserRelationships, '5', {'user_timeline' =&gt; {UUID.new =&gt; '1'}})
twitter.insert(:UserRelationships, '5', {'user_timeline' =&gt; {UUID.new =&gt; '2'}})
</pre>
<p>The <code>UUID.new</code> call creates a collation key based on the current time; our tweet ids are stored in the values.</p>
<p>Now we can query our user’s tweets:</p>
<pre>timeline = twitter.get(:UserRelationships, '5', 'user_timeline', :reversed =&gt; true)
timeline.map { |time, id| twitter.get(:Statuses, id, 'text') }
# =&gt; ["@evan Zzzz....", "Nom nom nom nom nom."]
</pre>
<p>Two tweet bodies, returned in recency order—not bad at all. In a 
similar fashion, each time a user tweets, we could loop through their 
followers and insert the status key into their follower’s <code>home_timeline</code> relationship, for handling general status delivery.</p>
<h2>the data model</h2>
<p>Cassandra is best thought of as a 4 or 5 dimensional hash. The usual way to refer to a piece of data is as follows: a <b>keyspace</b>, a <b>column family</b>, a <b>key</b>, an <i>optional</i> <b>super column</b>, and a <b>column</b>. At the end of that chain lies a single, lonely value.</p>
<p>Let’s break down what these layers mean.</p>
<ul>
<li>
<p><b>Keyspace</b> (also confusingly called “table”): the outer-most 
level of organization. This is usually the name of the application. For 
example, <code>'Twitter'</code> and <code>'Wordpress'</code> are both good keyspaces. Keyspaces must be defined at startup in the <code>storage-conf.xml</code> file.</p>
</li>
<li>
<p><b>Column family</b>: a slice of data corresponding to a particular 
key. Each column family is stored in a separate file on disk, so it can 
be useful to put frequently accessed data in one column family, and 
rarely accessed data in another. Some good column family names might be <code>:Posts</code>, <code>:Users</code> and <code>:UserAudits</code>. Column families must be defined at startup.</p>
</li>
<li>
<p><b>Key</b>: the permanent name of the record. You can query over ranges of keys in a column family, like <code>:start =&gt; '10050', :finish =&gt; '10070'</code>—this is the only index Cassandra provides for free. Keys are defined on the fly.</p>
</li>
</ul>
<p>After the column family level, the organization can diverge—this is a feature unique to Cassandra. You can choose either:</p>
<ul>
<li>
<p>A <b>column</b>: this is a tuple with a name and a value. Good columns might be <code>'screen_name' =&gt; 'lisa4718'</code> or <code>'Google' =&gt; 'http://google.com'</code>.</p>
<p>It is common to not specify a particular column name when requesting a
 key; the response will then be an ordered hash of all columns. For 
example, querying for <code>(:Users, '174927')</code> might return:</p>
<pre>{'name' =&gt; 'Lisa Jones',
 'gender' =&gt; 'f',
 'screen_name' =&gt; 'lisa4718'}
</pre>
<p>In this case, <code>name</code>, <code>gender</code>, and <code>screen_name</code>
 are all column names. Columns are defined on the fly, and different 
records can have different sets of column names, even in the same 
keyspace and column family. This lets you use the column name itself as 
either <b>structure</b> or <b>data</b>. Columns can be stored in recency order, or alphabetical by name, and all columns keep a timestamp.</p>
</li>
<li>
<p>A <b>super column</b>: this is a named list. It contains standard columns, stored in recency order.</p>
<p>Say Lisa Jones has bookmarks in several categories. Querying <code>(:UserBookmarks, '174927')</code> might return:</p>
<pre>{'work' =&gt; {
    'Google' =&gt; 'http://google.com',
    'IBM' =&gt; 'http://ibm.com'},
 'todo': {...},
 'cooking': {...}}
</pre>
<p>Here, <code>work</code>, <code>todo</code>, and <code>cooking</code> are all super column names. They are defined on the fly, and there can be any number of them per row. <code>:UserBookmarks</code> is the name of the <b>super column family</b>. Super columns are stored in alphabetical order, with their sub columns physically adjacent on the disk.</p>
</li>
</ul>
<p>Super columns and standard columns cannot be mixed at the same (4th) 
level of dimensionality. You must define at startup which column 
families contain standard columns, and which contain super columns with 
standard columns inside them.</p>
<p>Super columns are a great way to store one-to-many indexes to other 
records: make the sub column names TimeUUIDs (or whatever you’d like to 
use to sort the index), and have the values be the foreign key. We saw 
an example of this strategy in the demo, above.</p>
<p>If this is confusing, don’t worry. We’ll now look at two example schemas in depth.</p>
<h2>twitter schema</h2>
<p>Here is the schema definition we used for the demo, above. It is based on Eric Florenzano’s <a href="http://github.com/ericflo/twissandra/tree/master">Twissandra</a>:</p>
<pre>&lt;Keyspace Name="Twitter"&gt;
  &lt;ColumnFamily CompareWith="UTF8Type" Name="Statuses" /&gt;
  &lt;ColumnFamily CompareWith="UTF8Type" Name="StatusAudits" /&gt;
  &lt;ColumnFamily CompareWith="UTF8Type" Name="StatusRelationships"
    CompareSubcolumnsWith="TimeUUIDType" ColumnType="Super" /&gt;
  &lt;ColumnFamily CompareWith="UTF8Type" Name="Users" /&gt;
  &lt;ColumnFamily CompareWith="UTF8Type" Name="UserRelationships"
    CompareSubcolumnsWith="TimeUUIDType" ColumnType="Super" /&gt;
&lt;/Keyspace&gt;
</pre>
<p>What could be in <code>StatusRelationships</code>? Maybe a list of 
users who favorited the tweet? Having a super column family for both 
record types lets us index each direction of whatever many-to-many 
relationships we come up with.</p>
<p>Here’s how the data is organized:</p>
<div style="text-align: center; margin-bottom: 10px;"><a href="http://blog.evanweaver.com/files/cassandra/twitter.jpg"><img src="index_files/twitter_small.jpg" alt="Click to enlarge"></a></div>
<p>Cassandra lets you distribute the keys across the cluster either randomly, or in order, via the <code>Partitioner</code> option in the <code>storage-conf.xml</code> file.</p>
<p>For the Twitter application, if we were using the order-preserving 
partitioner, all recent statuses would be stored on the same node. This 
would cause hotspots. Instead, we should use the random partitioner.</p>
<p>Alternatively, we could preface the status keys with the user key, which has less temporal locality. If we used <code>user_id:status_id</code> as the status key, we could do range queries on the user fragment to get tweets-by-user, avoiding the need for a <code>user_timeline</code> super column.</p>
<h2>multi-blog schema</h2>
<p>Here’s a another schema, suggested to me by <a href="http://spyced.blogspot.com/">Jonathan Ellis</a>, the primary Cassandra maintainer. It’s for a multi-tenancy blog platform:</p>
<pre>&lt;Keyspace Name="Multiblog"&gt;
  &lt;ColumnFamily CompareWith="TimeUUIDType" Name="Blogs" /&gt;
  &lt;ColumnFamily CompareWith="TimeUUIDType" Name="Comments"/&gt;
&lt;/Keyspace&gt;
</pre>
<p>Imagine we have a blog named ‘The Cutest Kittens’. We will insert a row when the first post is made as follows:</p>
<pre>require 'rubygems'
require 'cassandra'
include SimpleUUID

multiblog = Cassandra.new('Multiblog')

multiblog.insert(:Blogs, 'The Cutest Kittens',
  { UUID.new =&gt;
    '{"title":"Say Hello to Buttons Cat","body":"Buttons is a cute cat."}' })
</pre>
<p><code>UUID.new</code> generates a unique, sortable column name, and the JSON hash contains the post details. Let’s insert another:</p>
<pre>multiblog.insert(:Blogs, 'The Cutest Kittens',
  { UUID.new =&gt;
    '{"title":"Introducing Commie Cat","body":"Commie is also a cute cat"}' })
</pre>
<p>Now we can find the latest post with the following query:</p>
<pre>post = multiblog.get(:Blogs, 'The Cutest Kittens', :reversed =&gt; true).to_a.first
</pre>
<p>On our website, we can build links based on the readable representation of the UUID:</p>
<pre>guid = post.first.to_guid
# =&gt; "b06e80b0-8c61-11de-8287-c1fa647fd821"
</pre>
<p>If the user clicks this string in a permalink, our app can find the post directly via:</p>
<pre>multiblog.get(:Blogs, 'The Cutest Kittens', :start =&gt; UUID.new(guid), :count =&gt; 1)
</pre>
<p>For comments, we’ll use the post UUID as the outermost key:</p>
<pre>multiblog.insert(:Comments, guid,
  {UUID.new =&gt; 'I like this cat. - Evan'})
multiblog.insert(:Comments, guid,
  {UUID.new =&gt; 'I am cuter. - Buttons'})
</pre>
<p>Now we can get all comments (oldest first) for a post by calling:</p>
<pre>multiblog.get(:Comments, guid)
</pre>
<p>We could paginate them by passing <code>:start</code> with a UUID. See <a href="http://www.slideshare.net/Eweaver/efficient-pagination-using-mysql">this presentation</a> to learn more about token-based pagination.</p>
<p>We have sidestepped two problems with this data model: we don’t have 
to maintain separate indexes for any lookups, and the posts and comments
 are stored in separate files, where they don’t cause as much write 
contention. Note that we didn’t need to use any super columns, either.</p>
<h2>storage layout and api comparison</h2>
<p>The storage strategy for Cassandra’s standard model is the same as BigTable’s. Here’s a comparison chart:</p>
<table class="tt">
<tbody><tr>
<th></th>
<th colspan="2">multi-file</th>
<th>per-file</th>
<th colspan="4" class="tt_right">intra-file</th>
</tr>
<tr>
<th>Relational</th>
<td>server</td>
<td>database</td>
<td>table*</td>
<td>primary key</td>
<td>column value</td>
<td></td>
<td class="tt_right"></td>
</tr>
<tr>
<th>BigTable</th>
<td>cluster</td>
<td>table</td>
<td>column family</td>
<td>key</td>
<td>column name</td>
<td>column value</td>
<td class="tt_right"></td>
</tr>
<tr>
<th>Cassandra, standard model</th>
<td>cluster</td>
<td>keyspace</td>
<td>column family</td>
<td>key</td>
<td>column name</td>
<td>column value</td>
<td class="tt_right"></td>
</tr>
<tr>
<th class="tt_footer">Cassandra, super column model</th>
<td class="tt_footer">cluster</td>
<td class="tt_footer">keyspace</td>
<td class="tt_footer">column family</td>
<td class="tt_footer">key</td>
<td class="tt_footer">super column name</td>
<td class="tt_footer">column name</td>
<td class="tt_footer tt_right">column value</td>
</tr>
</tbody></table>
<p style="font-size: 12px; text-align: right; margin-top: 0pt;">* With fixed column names.</p>
<p>Column families are stored in <b>column-major</b> order, which is why people call BigTable a column-oriented database. This is not the same as a<br>
column-oriented OLAP database like Sybase IQ—it depends on whether your 
data model considers keys to span column families or not.</p>
<div style="text-align: center;"><a href="http://blog.evanweaver.com/files/cassandra/row_oriented.jpg"><img src="index_files/row_oriented_small.jpg" alt="Click to enlarge"></a></div>
<p>In row-orientation, the column names are the <b>structure</b>, and you think of the column families as <b>containing keys</b>. This is the convention in relational databases.</p>
<div style="text-align: center;"><a href="http://blog.evanweaver.com/files/cassandra/column_oriented.jpg"><img src="index_files/column_oriented_small.jpg" alt="Click to enlarge"></a></div>
<p>In column-orientation, the column names are the <b>data</b>, and the column families are the structure. You think of the key as <b>containing the column family</b>,
 which is the convention in BigTable. (In Cassandra, super columns are 
also stored in column-major order—all the sub columns are together.)</p>
<p>In Cassandra’s Ruby API, parameters are expressed in storage order, for clarity:</p>
<table class="tt">
<tbody><tr>
<th>Relational</th>
<td class="tt_right"><code>SELECT `column` FROM `database`.`table` WHERE `id` = key;</code></td>
</tr>
<tr>
<th>BigTable</th>
<td class="tt_right"><code>table.get(key, "column_family:column")</code></td>
</tr>
<tr>
<th>Cassandra: standard model</th>
<td class="tt_right"><code>keyspace.get("column_family", key, "column")</code></td>
</tr>
<tr>
<th class="tt_footer">Cassandra: super column model</th>
<td class="tt_footer tt_right"><code>keyspace.get("column_family", key, "super_column", "column")</code></td>
</tr>
</tbody></table>
<p>Note that Cassandra’s internal Thrift interface mimics BigTable in some ways, but this is being changed.</p>
<h2>going to production</h2>
<p>Cassandra is an alpha product and could, theoretically, lose your 
data. In particular, if you change the schema specified in the <code>storage-conf.xml</code> file, you must follow <a href="https://issues.apache.org/jira/browse/CASSANDRA-44">these instructions</a>
 carefully, or corruption will occur (this is going to be fixed). Also, 
the on-disk storage format is subject to change, making upgrading a bit 
difficult.</p>
<p>The biggest deployment is at Facebook, where hundreds of terabytes of
 token indexes are kept in about a hundred Cassandra nodes. However, 
their use case<br>
allows the data to be rebuilt if something goes wrong. Proceed carefully, keep a backup in an <a href="http://mashable.com/2009/01/30/magnolia-data-loss/">unrelated storage engine</a>…and submit patches if things go wrong. (Some other production<br>
deployments are listed <a href="http://www.dbms2.com/2010/07/06/riptano-and-cassandra-adoption/">here</a>.)</p>
<p>That aside, here is a guide for deploying a production cluster:</p>
<ul>
<li>
<p><b>Hardware</b>: get a handful of commodity Linux servers. 16GB 
memory is good; Cassandra likes a big filesystem buffer. You don’t need 
RAID. If you put the commitlog file and the data files on separate 
physical disks, things will go faster. Don’t use EC2 or friends without 
being aware that the virtualized I/O can be slow, especially on the 
small instances.</p>
</li>
<li>
<p><b>Configuration</b>: in the <code>storage-conf.xml</code> schema 
file, set the replication factor to 3. List the IP address of one of the
 nodes as the seed. Set the listen address to the empty string, so the 
hosts will resolve their own IPs. Now, adjust the contents of <code>cassandra.in.sh</code> for your various paths and JVM options—for a 16GB node, set the JVM heap to 4GB.</p>
</li>
<li>
<p><b>Deployment</b>: build a package of Cassandra itself and your configuration files, and deliver it to all your servers (I use <a href="http://en.wikipedia.org/wiki/Capistrano">Capistrano</a> for this). Start the servers by setting <code>CASSANDRA_INCLUDE</code> in the environment to point to your <code>cassandra.in.sh</code> file, and run <code>bin/cassandra</code>. At this point, you should see join notices in the Cassandra logs:</p>
<pre>Cassandra starting up...
Node 10.224.17.13:7001 has now joined.
Node 10.224.17.14:7001 has now joined.
</pre>
<p>Congratulations! You have a cluster. Don’t forget to turn off debug logging in the <code>log4j.properties</code> file.</p>
</li>
<li>
<p><b>Visibility</b>: you can get a little more information about your cluster via the tool <code>bin/nodeprobe</code>, included:</p>
<pre>$ bin/nodeprobe --host 10.224.17.13 ring
Token(124007023942663924846758258675932114665)  3 10.224.17.13  |&lt;--|
Token(106858063638814585506848525974047690568)  3 10.224.17.19  |   ^
Token(141130545721235451315477340120224986045)  3 10.224.17.14  |--&gt;|
</pre>
<p>Cassandra also exposes various statistics over <a href="http://en.wikipedia.org/wiki/Java_Management_Extensions">JMX</a>.</p>
</li>
</ul>
<p>Note that your client machines (not servers!) must have accurate clocks for Cassandra to resolve write conflicts properly. Use <a href="http://en.wikipedia.org/wiki/Network_Time_Protocol">NTP</a>.</p>
<h2>conclusion</h2>
<p>There is a misperception that if someone advocates a non-relational 
database, they either don’t understand SQL optimization, or they are 
generally a hater. This is not the case.</p>
<p>It is reasonable to seek a new tool for a new problem, and database 
problems have changed with the rise of web-scale distributed systems. 
This does not mean that SQL as a general-purpose runtime and reporting 
tool is going away. However, at web-scale, it is more flexible to 
separate the concerns. Runtime object lookups can be handled by a 
low-latency, strict, self-managed system like Cassandra. Asynchronous 
analytics and reporting can be handled by a high-latency, flexible, 
un-managed system like <a href="http://hadoop.apache.org/core/">Hadoop</a>. And in neither case does SQL lend itself to sharding.</p>
<p>I think that Cassandra is the most promising current implementation 
of a runtime distributed database, but much work remains to be done. 
We’re beginning to use Cassandra at Twitter, and here’s what I would 
like to happen real-soon-now:</p>
<ul>
<li><b>Interface cleanup</b>: <span style="text-decoration: line-through;">the Thrift API for Cassandra is incomplete and inconsistent, which makes writing<br>
clients very irritating.</span><br>Done!</li>
<li><b>Online migrations</b>: restarting the cluster 3 times to add a column family is silly.</li>
<li><b>ActiveModel or DataMapper adapter</b>: <span style="text-decoration: line-through;">for interaction with business objects in Ruby.</span><br>Done!<br>
Michael<br>
Koziarski on the Rails core team wrote an <a href="http://github.com/NZKoz/cassandra_object">ActiveModel adapter</a>.</li>
<li><b>Scala client</b>: for interoperability with JVM middleware.</li>
</ul>
<p>Go ahead and jump on any of those projects—it’s a chance to get in on the ground floor.</p>
<p>Cassandra has excellent performance. There some benchmark results for version 0.5 at the end of the <a href="http://www.brianfrankcooper.net/pubs/ycsb-v4.pdf"> Yahoo performance study</a>.</p>
<h2>further resources</h2>
<ul>
<li><a href="http://wiki.apache.org/cassandra/">Cassandra wiki</a></li>
<li>Presentation by Avinash Lakshman about Cassandra: <a href="http://www.slideshare.net/Eweaver/cassandra-presentation-at-nosql">slides</a>, <a href="http://vimeo.com/5185526">video</a></li>
<li>The <a href="http://mail-archives.apache.org/mod_mbox/incubator-cassandra-user/">cassandra-user</a> and <a href="http://mail-archives.apache.org/mod_mbox/incubator-cassandra-user/">cassandra-dev</a> mailing lists</li>
<li>The #cassandra IRC channel on <a href="irc://irc.freenode.net/cassandra">irc.freenode.net</a></li>
<li>Cassandra’s <a href="http://issues.apache.org/jira/browse/CASSANDRA">bug tracker</a></li>
<li>Twitter’s Ruby client: <a href="http://blog.evanweaver.com/files/doc/fauna/cassandra_client">docs</a>, <a href="http://github.com/fauna/cassandra_client/">source</a></li>
<p>&lt;!–
</p><li>Matt Revelle’s <a href="http://github.com/mattrepl/clojure-cassandra/tree/master">Clojure client</a></li>
<p>–&gt;
</p></ul>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/up-and-running-with-cassandra-2/#comments" title="Comment on up and running with&nbsp;cassandra">Comments (26)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-290" class="hentry p7 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/distributed-systems-primer-2/" title="Permalink to distributed systems&nbsp;primer" rel="bookmark">distributed systems&nbsp;primer</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:50:56-0800">November 30, 2010 – 2:50 AM</abbr></div>
				<div class="entry-content">
<p>I’ve been reading a bunch of papers about distributed systems recently, in order to help systematize for myself <a href="http://twitter.com/">the thing that we built</a> over the last year. Many of them were originally passed to me by <a href="http://cbcg.net/">Toby DiPasquale</a>. Here is an annotated list so everyone can benefit.</p>
<p>It helps if you have some algorithms literacy, or have built a system at scale, but don’t let that stop you.</p>
<h2>prelude</h2>
<p><a href="http://www.julianbrowne.com/article/viewer/death-of-architecture">The Death of Architecture</a>, Julian Browne, 2007.</p>
<p>First, a reminder of what it means to build a system that solves a business problem. Browne built the <a href="http://julianbrowne.com/article/viewer/space-based-architecture-example">space-based billing system at Virgin Mobile</a>, one of the most well-known SBAs outside the financial and research industries.</p>
<p style="margin-left: 35px; margin-right: 35px;"><em>That lovely 
diagram showing clean service-oriented interfaces, between unified 
systems of record, holding clean data, performing well-defined business 
processes is never going to be….You have to roll up your sleeves, talk 
to the business analysts, developers, operations and make a contribution
 that makes those boxes and arrows real.</em></p>
<p>System failures in the web world are most often due to inflated 
technical requirements and integration risks, not an incorrect decision 
to skip two-phase commit.</p>
<h2>constraints</h2>
<p style="margin-bottom: 2px;"><a href="http://db.cs.berkeley.edu/papers/hpts85-nothing.pdf">The Case for Shared Nothing</a>, Michael Stonebraker, 1985.</p>
<p>The source of the shared-nothing paradigm, and importantly, its 
alternatives. Shared-nothing is a nice hammer, but not every problem is a
 nail.</p>
<p style="margin-bottom: 2px;"><a href="http://tinyurl.com/cc5648">Harvest, Yield and Scalable Tolerant systems</a>, Eric Brewer, 1999.</p>
<p>The CAP theorem. Sometimes you just can’t get what you want. (This is related to the Dynamo work, below.)</p>
<p style="margin-bottom: 2px;"><a href="http://research.microsoft.com/pubs/70001/tr-2003-24.pdf">Distributed Computing Economics</a>, Jim Gray, 2003.</p>
<p>How to predict the cost of the thing you want to build. Via some 
napkin math, Gray shows why making the cloud cost-efficient for current 
problems continues to be a struggle.</p>
<h2>coordination</h2>
<p style="margin-bottom: 2px;"><a href="http://pdos.csail.mit.edu/6.824/papers/liskov-argus.pdf">Guardians and Actions: Linguistic Support for Robust, Distributed Programs</a>, Barbara Liskov and Robert Scheifler, 1983.</p>
<p>Two-phase commit. Making sure what you plan to do will get done. </p>
<p style="margin-bottom: 2px;"><a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/time-clocks.pdf">Time, Clocks and the Ordering of Events in a Distributed System</a>, Leslie Lamport, 1978.</p>
<p>Distributed systems are inherently relative; there is no privileged 
position that can describe all events exactly. Lamport clocks (and the 
closely related vector clocks) let participants agree on the order of 
events in the world, if you need to care about that.</p>
<p style="margin-bottom: 2px;"><a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/paxos-simple.pdf">Paxos Made Simple</a>, Leslie Lamport, 2001.</p>
<p>The consensus problem: how can potentionally faulty processes agree 
about an element of global state? The Paxos algorithm guarantees 
correctness during a failure of a minority of nodes. This paper is 
difficult, but important for the subtleties it reveals.</p>
<p>Also see <a href="http://www.chandrakin.com/paper2.pdf">Paxos Made Live</a> for a discussion of the implementation in Google’s Chubby v2 coordination server. Real life introduces many unfortunate kinks.</p>
<h2>encapsulation</h2>
<p style="margin-bottom: 2px;"><a href="http://www-csag.ucsd.edu/teaching/cse291s03/Readings/p80-gelernter.pdf">Generative Communication in Linda</a>, David Gelernter, 1985.</p>
<p>Tuple spaces, a.k.a. the blackboard pattern, a.k.a. spaced-based 
architecture. Coordinating a system through the data, not through the 
behaviors. I will be writing a lot more about this in the future.</p>
<h2>partitioning</h2>
<p style="margin-bottom: 2px;"><a href="http://pdos.csail.mit.edu/papers/chord:sigcomm01/chord_sigcomm.pdf">Chord: A Scalable Peer-to-peer Lookup Service for Internet Applications</a>, Ion Stoica, et al., 2001.</p>
<p>The original distributed hash table paper. Introduced consistent hashing for robust pool rebalancing.</p>
<p style="margin-bottom: 2px;"><a href="http://pdos.csail.mit.edu/6.824/papers/thekkath-frangipani.pdf">Frangipani: A Scalable Distributed File System</a>, Chandramohan A. Thekkath, Timothy Mann and Edward K. Lee, 1998.</p>
<p>Classic paper regarding modern-style distributed filesystems.</p>
<h2>systems integration</h2>
<p style="margin-bottom: 2px;"><a href="http://s3.amazonaws.com/AllThingsDistributed/sosp/amazon-dynamo-sosp2007.pdf">Dynamo: Amazon’s Highly Available Key-Value Store</a>, Giuseppe DeCandia, et al., 2007.</p>
<p>A key-value store that spawned numerous clones, it integrated many 
fundamental ideas from the above works into an actual running system. <a href="http://cwiki.apache.org/confluence/display/CSDR/Index">Cassandra</a> is the most featureful open-source version.</p>
<p>(Also see <a href="http://tokyocabinet.sourceforge.net/">Tokyo Cabinet</a>.
 Not a Dynamo clone, per se, but it’s the next most practical 
alternative aside from MySQL. Tokyo is a networked BerkeleyDB 
replacement, so the domain code must handle the distributed aspects.)</p>
<p style="margin-bottom: 2px;"><a href="http://www.eecs.harvard.edu/%7Emdw/papers/seda-sosp01.pdf">SEDA: An Architecture for Well-Conditioned, Scalable Internet Services</a>, Matt Welsh, David Culler, and Eric Brewer, 2001.</p>
<p>Great paper on managing the interactions between individual 
components, and ways to build a well-conditioned service under 
unpredictable load.</p>
<h2>conclusion</h2>
<p>That’s all really. Focus on the ideas, not the implementations. Try 
to see the patterns in existing systems, rather than imagining how they 
“should” work if everything was perfect. Then you’ll be able to scale to
 the moon.</p>
<p>The moon is above the cloud and therefore <em>obviously</em> more scaleable.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/distributed-systems-primer-2/#comments" title="Comment on distributed systems&nbsp;primer">Comments (8)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-289" class="hentry p8 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18 alt">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/peeping-into-memcached-2/" title="Permalink to peeping into&nbsp;memcached" rel="bookmark">peeping into&nbsp;memcached</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:50:54-0800">November 30, 2010 – 2:50 AM</abbr></div>
				<div class="entry-content">
<p><a href="http://code.google.com/p/memcached/">Memcached</a> is 
generally treated as a black box. But what if you really need to know 
what’s in there? Not for runtime purposes, but for optimization and 
capacity planning?</p>
<h2>demo</h2>
<pre>$ sudo peep --pretty 2479

time | exptime | nbytes | clsid |                 key | exprd | flushd
8658 |  613458 |    272 |     5 |      "c3RhdH:171:5" | false |  false
8658 |       0 |      6 |     1 |  "current_c3RhdH:3" | false |  false
8658 |  613458 |    281 |     5 |     "c3RhdH:171:26" | false |  false
8678 |   95078 |      6 |     1 |  "User:1:auth:m4Uq" | false |  false
8658 |       0 |      8 |     2 |   "user_dGltZWxp:4" | false |  false
8686 |  613486 |   1278 |     9 |          "User:1:6" | false |  false
8658 |  613458 |   1286 |     9 |          "User:1:4" | false |  false
...
8658 |  613458 |    283 |     5 |     "c3RhdH:171:28" | false |  false
8658 |  613458 |    277 |     5 |     "c3RhdH:171:30" | false |  false
</pre>
<p>Peep uses <code>ptrace</code> to freeze a running memcached server, 
dump the internal key metadata, and return the server to a running 
state. If you have a good host ejection mechanism in your client, such 
as in the Twitter <a href="http://blog.evanweaver.com/articles/2009/01/24/secret-codes/">libmemcached builds</a>, you won’t even have to change the production server pool. The instance is not restarted, and no data is lost.</p>
<p>Installation instructions are <a href="http://blog.evanweaver.com/files/doc/fauna/peep/files/README.html">here</a>. Requires Linux.</p>
<h2>a note about heap management</h2>
<p>Memcached has two separate memory management strategies:</p>
<ul>
<li>On read, if a key is past its expiry time, return <code>NOT FOUND</code>.</li>
<li>On write, choose an appropriate slab class for the value; if it’s 
full, replace the oldest-used (read or written) key with the new one.</li>
</ul>
<p>Note that the second strategy, LRU eviction, does not check the 
expiry time at all. This makes eviction an O(1) operation, because the 
tail of the LRU linked list is immediately available; checking within 
that list for evicted keys first would raise the order to O(N). This 
optimization has subtle implications.</p>
<h2>the problem</h2>
<p>In the bad old days, we added a page cache to Twitter via memcached. 
We used a generational key scheme: a piece of user metadata was 
incremented on every change, and used to construct dependent keys. This 
eliminated direct invalidation concerns.</p>
<p>However, because of the orthogonal expiry and LRU strategies, we knew
 that the generational keys were affecting our evictions of direct keys.
 The continual massive onslaught of new generational keys would sweep 
out older direct keys, even when the generational keys were expired, but
 the direct keys were fresh.</p>
<p>But how could we prove it was happening? Eventually we ran peep on a 
representative server. Aggregate results showed that 75% of our cache 
pool was spent on expired page caches, and our cache horizon was only 5 
hours. Moving the generational keys to a separate pool raised our cache 
horizon to two days, a 10x improvement.</p>
<h2>aggregating results</h2>
<p>The best way to aggregate peep results is to use MySQL’s excellent grouping abilities. Run peep with the <code>--ugly</code> (unformatted) switch, and pipe it to a file. Then you can load it into an approprate MySQL schema:</p>
<pre>CREATE TABLE entries (
  lru_time int(11) default NULL,
  expires_at_time int(11) default NULL,
  value_size int(11) default NULL,
  suffix_size int(11) default NULL,
  it_flag varchar(255) default NULL,
  class_id int(11) default NULL,
  key_size int(11) default NULL,
  key_name varchar(255) default NULL,
  is_expired varchar(255) default NULL,
  is_flushed varchar(255) default NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

LOAD DATA LOCAL INFILE '/tmp/peep.txt' INTO TABLE entries
  FIELDS TERMINATED BY ' | ' LINES TERMINATED BY '\n';
</pre>
<p>This will load very fast, even for millions of keys on a laptop;  <code>LOAD LOCAL INFILE</code> is an optimized pipeline.</p>
<p>Here are some handy queries for revealing cache properties:</p>
<p><strong>fresh vs. expired values, by count and size</strong></p>
<pre>SELECT
  is_expired,
  COUNT(*),
  SUM(value_size)
FROM entries
GROUP BY is_expired;

+------------+----------+-----------------+
| is_expired | COUNT(*) | SUM(value_size) |
+------------+----------+-----------------+
|  false     |   688883 |       759401296 |
|  true      |   472755 |      2430092660 |
+------------+----------+-----------------+
</pre>
<p><strong>histogram of values by size</strong></p>
<pre>SELECT
  ROUND(ROUND(LOG10(value_size) * 5, 0) / 5, 1) AS log,
  ROUND(AVG(value_size), 0) AS size,
  COUNT(*),
  RPAD('', COUNT(*) / 6500, '*') AS bar
FROM entries
GROUP BY log
ORDER BY log DESC;

+------+--------+----------+----------------------------------------+
| log  | size   | COUNT(*) | bar                                    |
+------+--------+----------+----------------------------------------+
|  5.6 | 422238 |        3 |                                        |
...
|  1.6 |     39 |     3652 | *                                      |
|  1.4 |     23 |   103434 | ************************************** |
|  1.2 |     14 |     6369 | *                                      |
|  1.0 |     11 |    36588 | ******                                 |
|  0.8 |      6 |    55795 | *********                              |
|  0.6 |      4 |    90332 | **************                         |
|  0.4 |      2 |      239 |                                        |
+------+--------+----------+----------------------------------------+
</pre>
<p><strong>histogram of values by LRU age</strong></p>
<pre>SELECT
  ROUND(ROUND(LOG10(
    (SELECT MAX(lru_time) FROM entries)
    - lru_time) * 5, 0) / 5, 1) AS log,
  ROUND(AVG(
    (SELECT MAX(lru_time) FROM entries)
    - lru_time), -2) AS lru_age,
  COUNT(*),
  RPAD('', COUNT(*) / 6500, '*') AS bar
FROM entries
GROUP BY log
ORDER BY log DESC;

+------+-----------+----------+-------------------------------------+
| log  |   lru_age | COUNT(*) | bar                                 |
+------+-----------+----------+-------------------------------------+
|  4.6 |     34800 |    18064 | ***                                 |
|  4.4 |     24200 |    96739 | ***************                     |
|  4.2 |     15700 |   212865 | *********************************   |
|  4.0 |     10200 |   224703 | *********************************** |
|  3.8 |      6500 |   158067 | ************************            |
|  3.6 |      4100 |   108034 | *****************                   |
...
|  0.4 |         0 |      672 |                                     |
|  0.0 |         0 |      319 |                                     |
| NULL |         0 |    13400 | **                                  |
+------+-----------+----------+-------------------------------------+
</pre>
<p><strong>histogram of values by size for a namespace</strong></p>
<pre>SELECT
  key_name,
  ROUND(ROUND(LOG10(value_size) * 5, 0) / 5, 1) AS log,
  ROUND(AVG(value_size), 0) AS size,
  COUNT(*),
  RPAD('', COUNT(*) / 10000, '*') AS bar
FROM entries
WHERE key_name LIKE '%chunk:%'
GROUP BY log
ORDER BY log desc;

+----------------------+------+-------+----------+----------------------+
| key_name             | log  | size  | COUNT(*) | bar                  |
+----------------------+------+-------+----------+----------------------+
|  reply_chunk:69913   |  3.4 |  2511 |     1032 | **                   |
|  user_chunk:1868495  |  3.2 |  1530 |      972 | **                   |
...
|  user_chunk:1405137  |  1.6 |    40 |     2822 | ******               |
|  reply_chunk:2084579 |  1.4 |    24 |     4361 | *********            |
|  user_chunk:2455162  |  1.2 |    14 |     6141 | ************         |
|  user_chunk:5989656  |  1.0 |    12 |     2477 | *****                |
|  user_chunk:2268781  |  0.8 |     6 |    16527 | ******************** |
+----------------------+------+-------+----------+----------------------+
</pre>
<p><strong>slab allocation counts by class</strong></p>
<pre>SELECT
  class_id AS slab_class,
  MAX(value_size) AS slab_size,
  CEIL(COUNT(*) / ((1024 * 1024) / MAX(value_size))) AS allocated,
  (
    (SELECT COUNT(*) FROM entries
     WHERE class_id = slab_class AND is_expired = "true")
   * 100
   /
    (SELECT COUNT(*)
     FROM entries
     WHERE class_id = slab_class)
  ) AS `%_expired`
FROM entries
GROUP BY class_id
ORDER BY class_id;

+------------+-----------+-----------+-----------+
| slab_class | slab_size | allocated | %_expired |
+------------+-----------+-----------+-----------+
|          1 |         8 |         1 |   99.8938 |
|          2 |        32 |         5 |    6.0320 |
|          3 |        71 |         9 |   36.4859 |
...
|         34 |    187783 |        28 |   61.2903 |
|         35 |    234205 |       130 |    1.8998 |
|         36 |    286110 |         7 |    0.0000 |
|         37 |    309832 |         2 |   75.0000 |
|         38 |    397500 |         1 |  100.0000 |
|         39 |    496014 |         1 |  100.0000 |
+------------+-----------+-----------+-----------+
</pre>
<p>This is comparable to the memcached <code>stats slabs</code> command, but lets you investigate things like expired ratio by slab, etc.</p>
<p>Play around and see what else you can come up with.</p>
<h2>conclusion</h2>
<p>Generational keys are often presented as the easy way to cache, but 
consider their implications. How else are you abusing your cache? Some 
suggested things to check:</p>
<ul>
<li>Keys without expiry times (which will bite you when you alter the server pool)</li>
<li>Excessive use of very large slabs</li>
<li>Uneven LRU age by slab (indicating poor slab allocation)</li>
<li>Unexpected namespaces (revealing invalidation bugs)</li>
</ul>
<p>The only unfortunate thing about peep right now is that it blocks the
 memcached server. I could do an incremental version, but it would be 
quite slow. The current version is already CPU-intensive, taking 15 
minutes to dump a 4GB memcached on modern hardware (turn off your 
client-facing processes if you run mixed front-ends!). A version in C 
would be much quicker, if someone is up for it, but for now the Ruby 
version is sufficient.</p>
<p>Happy peeping.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/peeping-into-memcached-2/#comments" title="Comment on peeping into&nbsp;memcached">Comments (10)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-288" class="hentry p9 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/ruby-gc-tuning-2/" title="Permalink to ruby gc&nbsp;tuning" rel="bookmark">ruby gc&nbsp;tuning</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:50:52-0800">November 30, 2010 – 2:50 AM</abbr></div>
				<div class="entry-content">
<p>I’d like to call out something important from my <a href="http://blog.evanweaver.com/articles/2009/03/13/qcon-presentation/">QCon slides</a>: the Railsbench GC settings.</p>
<h2>quick study</h2>
<p>In my experience, a typical production Rails app on Ruby 1.8 can recover 20% to 40% of user CPU by applying Stefan Kaes’s <a href="http://github.com/skaes/railsbench/tree/master">Railsbench GC patch</a> to the Ruby binary, and using the following environment variables:</p>
<pre>RUBY_HEAP_MIN_SLOTS=500000
RUBY_HEAP_SLOTS_INCREMENT=250000
RUBY_HEAP_SLOTS_GROWTH_FACTOR=1
RUBY_GC_MALLOC_LIMIT=50000000
</pre>
<p>In return, you get a minor increase in peak memory consumption. Not too shabby.</p>
<h2>gc behavior</h2>
<p>Ruby’s GC is non-generational, which means that the GC looks at every object every time it runs.<br>
Java, OCaml, and other static languages have a generational GC, which 
means that only recent allocations are frequently checked (the<br>
older an object is, the less likely it is to be freeable). But Ruby pays a high cost each<br>
GC run because it looks at all old objects too; for example, the Rails code itself stored in the AST.</p>
<p>Writing a generational GC is quite difficult, but there is one thing 
we can do: run the GC less frequently. This is what Stefan’s patches 
allow.</p>
<h2>how to tune your app</h2>
<p>If you install <a href="http://rubyforge.org/tracker/download.php/426/1700/11497/2087/ruby-track-alloc.patch">this patch</a>
 from Sylvain Joyeux, you can add object allocation deltas to your Rails
 log, as well as use Stefan’s GC tracking methods. This gives you 
visibility into exactly when the GC runs and how much useful work it 
does. Spin up <code>ab</code> and script a representative page. Also start <code>top</code> in another shell to watch total memory in the Rails process.</p>
<p>Now, do a simulated annealing-like search through the <a href="http://github.com/skaes/railsbench/blob/a1d30119d9b5c484f696b1bc15a6cf938dcc8d9a/GCPATCH">available environment settings</a>.</p>
<h2>example</h2>
<p>Here is one of our test runs with Ruby’s default GC settings (we use a
 custom logger at Twitter, but you should be able to arrive at similar 
output):</p>
<pre>tcpu:0.154 alloc:63926 delta:-66290 gccpu:0.078
tcpu:0.067 alloc:63640 delta:63645 gccpu:0.000
tcpu:0.146 alloc:63788 delta:-68896 gccpu:0.078
tcpu:0.060 alloc:63779 delta: 63784 gccpu:0.000
tcpu:0.138 alloc:63787 delta:-75152 gccpu:0.072
tcpu:0.059 alloc:63779 delta: 63784 gccpu:0.000
tcpu:0.138 alloc:63787 delta:-77591 gccpu:0.072
tcpu:0.062 alloc:63779 delta: 63784 gccpu:0.000
</pre>
<p>With the conservative Ruby defaults, the GC runs every other request,
 and takes 0.075 seconds, giving us a per-request GC cost of 0.038 
seconds—40% of the entire request time.</p>
<p>This is excessive. But if you explore a bit, you will quickly arrive at something like <code>RUBY_HEAP_MIN_SLOTS=500000 RUBY_HEAP_SLOTS_INCREMENT=250000 RUBY_HEAP_SLOTS_GROWTH_FACTOR=1 RUBY_GC_MALLOC_LIMIT=50000000</code>, which is what we use at Twitter.</p>
<p>These particular settings mean:</p>
<ul>
<li>Start with enough memory to hold Rails (Ruby’s default is practically nothing)</li>
<li>Increase it linearly if you need more (Ruby’s default is exponential increase)</li>
<li>Only garbage-collect every 50 million <code>malloc</code> calls (Ruby’s default is 6x smaller)</li>
</ul>
<p>Here are the GC timings for the same <code>ab</code> run with these settings applied:</p>
<pre>tcpu:0.181 alloc:63829 delta:-763708 gccpu:0.118
tcpu:0.067 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.062 alloc:63777 delta: 63782 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.058 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.063 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.058 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.063 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.059 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.185 alloc:63828 delta:-761854 gccpu:0.119
tcpu:0.069 alloc:63777 delta: 63782 gccpu:0.000
tcpu:0.065 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.058 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.062 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.061 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.062 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.062 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.059 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.060 alloc:63776 delta: 63781 gccpu:0.000
tcpu:0.062 alloc:63775 delta: 63780 gccpu:0.000
</pre>
<p>Woah! Now the GC runs only every 13 requests, at a slightly higher 
cost, for a per-request cost of 0.009 seconds. This translates to a 
general speedup of 34%. The frequency of GC calls corresponds quite 
directly to the change in <code>RUBY_GC_MALLOC_LIMIT</code>, but if we increase it much more the memory usage balloons.</p>
<h2>further reading</h2>
<p>Unfortunately, there’s not much clear information on the Ruby garbage collector. But here are a few resources:</p>
<ul>
<li><a href="http://glu.ttono.us/articles/2006/06/23/Stefan-kaes-optimizing-rails">Optimizing Rails</a>. Second-hand notes on on old presentation of Stefan’s.</li>
<li><a href="http://blog.pluron.com/">Acunote team blog</a>. Has some good but scattered GC information.</li>
<li><a href="http://www.rubyenterpriseedition.com/documentation.html#_garbage_collector_performance_tuning">REE documentation</a>. Phusion NL discusses Stefan’s patch.</li>
<li><a href="http://sites.google.com/site/brentsrubypatches/">Brent Roman’s MBARI explanations</a>. Detailed discussion of various leaks and optimizations.</li>
</ul>
<p>We are now experimenting with Brent’s <a href="http://github.com/brentr/matzruby/tree/v1_8_6_287-mbari">MBARI branch of Ruby 1.8.6</a>, kindly sponsored by <a href="http://www.engineyard.com/">EngineYard</a>. So far it looks excellent, expecially in combination with Stefan’s patches. I will publish some results soon.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/ruby-gc-tuning-2/#comments" title="Comment on ruby gc&nbsp;tuning">Comments (9)</a></span>
				</div>
			</div><!-- .post -->



			<div id="post-287" class="hentry p10 post publish author-evan category-uncategorized untagged y2010 m11 d29 h18 alt">
				<h2 class="entry-title"><a href="http://evanweaver.wordpress.com/2010/11/30/qcon-presentation-2/" title="Permalink to qcon&nbsp;presentation" rel="bookmark">qcon&nbsp;presentation</a></h2>
				<div class="entry-date"><abbr class="published" title="2010-11-30T02:50:50-0800">November 30, 2010 – 2:50 AM</abbr></div>
				<div class="entry-content">
<p>My QCon presentation is available.</p>
<p><strong><a href="http://www.slideshare.net/Eweaver/improving-running-components-at-twitter">Improving Running Components at Twitter</a></strong></p>
<div style="width: 425px; text-align: left;" id="__ss_1141786"><a href="http://tinyurl.com/dfj3cr">http://tinyurl.com/dfj3cr</a></div>
<p>Some choice Tweets:</p>
<ul>
<li><a href="http://twitter.com/philwills/status/1321776154">philwills</a>: Evan Weaver on scaling twitter at #qcon was full of<br>
interesting stuff and good questions from audience.</li>
<li><a href="http://twitter.com/markhneedham/statuses/1321638881">markhneedham</a>: fascinating reading these stats about #twitter<br>
from Evan Weaver’s talk #qcon</li>
<li><a href="http://twitter.com/jurgenonland/statuses/1321564733">jurgenonland</a>: sitting at a presentation from Evan Weaver @<br>
#qcon, wow he must be verry unhappy at his work</li>
<li><a href="http://twitter.com/szegedi/status/1321632939">szegedi</a>: Listening to Evan Weaver talking about Twitter system<br>
architecture &amp; tuning. Getting to learn from these experiences is priceless.</li>
<li><a href="http://twitter.com/rbanks54/status/1321617085">rbanks54</a>: This could be a great presentation, but Evan is<br>
presenting it monotone/bored &amp; skipping important links :-( #qcon</li>
<li><a href="http://twitter.com/oudenampsen/statuses/1321848814">oudenampsen</a>: Was just by Evan Weaver of twitter. Gave the impression that any time he could commit suicide. However interesting.</li>
</ul>
<p>My presentation abilities have gone from “bad” to “tolerable”, so I’m relatively satisfied with the situation. Clearly I need to<br>
be more engaging.</p>

								</div>
				<div class="entry-meta">
					<span class="author vcard">By <a class="url fn n" href="http://evanweaver.wordpress.com/author/evanweaver/" title="View all posts by evan">evan</a></span>
					<span class="meta-sep">|</span>
					<span class="cat-links">Posted in <a href="http://evanweaver.wordpress.com/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a></span>
					<span class="meta-sep">|</span>
										<span class="comments-link"><a href="http://evanweaver.wordpress.com/2010/11/30/qcon-presentation-2/#comments" title="Comment on qcon&nbsp;presentation">Comments (11)</a></span>
				</div>
			</div><!-- .post -->



			<div id="nav-below" class="navigation">
				<div class="nav-previous"><a href="http://evanweaver.wordpress.com/page/2/"><span class="meta-nav">«</span> Older posts</a></div>
				<div class="nav-next"></div>
			</div>

		</div><!-- #content -->
	</div><!-- #container -->

	<div id="primary" class="sidebar">
		<ul class="xoxo">

			<li id="nav_menu-2" class="widget widget_nav_menu">
				<h3 class="widgettitle">meta</h3>
<div class="menu-meta-container"><ul id="menu-meta" class="menu"><li id="menu-item-423" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-423"><a href="http://evanweaver.wordpress.com/about/">About</a></li>
<li id="menu-item-424" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-424"><a href="http://resume/">resume</a></li>
<li id="menu-item-425" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-425"><a href="https://github.com/fauna">github</a></li>
<li id="menu-item-426" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-426"><a href="http://cloudbur.st/">cloudburst</a></li>
<li id="menu-item-427" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-427"><a href="http://web2nam.es/">web2names</a></li>
</ul></div>
			</li>

			<li id="rss_links-2" class="widget widget_rss_links">
				<h3 class="widgettitle">subscribe</h3>
<p><a href="http://evanweaver.wordpress.com/feed/" title="Subscribe to Posts"><img src="index_files/orange-small.png" alt="RSS Feed"></a>&nbsp;<a href="http://evanweaver.wordpress.com/feed/" title="Subscribe to Posts">RSS - Posts</a></p><p><a href="http://evanweaver.wordpress.com/comments/feed/" title="Subscribe to Comments"><img src="index_files/orange-small.png" alt="RSS Feed"></a>&nbsp;<a href="http://evanweaver.wordpress.com/comments/feed/" title="Subscribe to Comments">RSS - Comments</a></p>

			</li>
		
			<li id="recent-posts-2" class="widget widget_recent_entries">		
				<h3 class="widgettitle">recent articles</h3>
		<ul>
				<li><a href="http://evanweaver.wordpress.com/2010/11/30/distributed-systems-primer-update-2/" title="distributed systems primer,&nbsp;updated">distributed systems primer,&nbsp;updated</a></li>
				<li><a href="http://evanweaver.wordpress.com/2010/11/30/object-allocations-on-the-web-2/" title="object allocations on the&nbsp;web">object allocations on the&nbsp;web</a></li>
				<li><a href="http://evanweaver.wordpress.com/2010/11/30/scribe-client-gem-2/" title="scribe&nbsp;client">scribe&nbsp;client</a></li>
				<li><a href="http://evanweaver.wordpress.com/2010/11/30/ree-2/" title="ree">ree</a></li>
				<li><a href="http://evanweaver.wordpress.com/2010/11/30/memcached-gem-release-2/" title="memcached gem&nbsp;release">memcached gem&nbsp;release</a></li>
				<li><a href="http://evanweaver.wordpress.com/2010/11/30/up-and-running-with-cassandra-2/" title="up and running with&nbsp;cassandra">up and running with&nbsp;cassandra</a></li>
				</ul>
		
			</li>
		
			<li id="top-posts" class="widget widget_stats_topposts">			
				<h3 class="widgettitle">popular</h3>
			<ul><li>None</li></ul>		
			</li>

			<li id="nav_menu-3" class="widget widget_nav_menu">
				<h3 class="widgettitle">projects</h3>
<div class="menu-big-projects-container"><ul id="menu-big-projects" class="menu"><li id="menu-item-428" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-428"><a href="http://blog.evanweaver.com/files/doc/fauna/memcached/files/README.html">memcached 1.0</a></li>
<li id="menu-item-429" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-429"><a href="http://blog.evanweaver.com/files/doc/fauna/zookeeper/files/README.html">zookeeper 0.3</a></li>
</ul></div>
			</li>
		<li id="twitter-2" class="widget widget_twitter">
				<h3 class="widgettitle"><a href="http://twitter.com/evan">twitter</a></h3>
<ul class="tweets">
<li>Coding CSS. <a href="http://twitter.com/evan/statuses/10590064169975808" class="timesince">56&nbsp;minutes&nbsp;ago</a></li>
<li>OH: "Take Frosty the Snowman, and shove him up your ass!" <a href="http://twitter.com/evan/statuses/10558015858016256" class="timesince">3&nbsp;hours&nbsp;ago</a></li>
<li>OH: "It doesn't mean that you think they're a bad person....but it doesn't rule it out." <a href="http://twitter.com/evan/statuses/10519458166611968" class="timesince">5&nbsp;hours&nbsp;ago</a></li>
<li>"Do we have a 'narwhals' team?" "I don't know...probably!" <a href="http://twitter.com/evan/statuses/10121066546466816" class="timesince">1&nbsp;day&nbsp;ago</a></li>
<li>Trouble sleeping. <a href="http://twitter.com/evan/statuses/9909639055409152" class="timesince">1&nbsp;day&nbsp;ago</a></li>
</ul>

			</li>
			
			<li id="search" class="widget widget_search">				
				<h3 class="widgettitle"><label for="s">search</label></h3>
				<form id="searchform" class="blog-search" method="get" action="http://evanweaver.wordpress.com">
					<div>
						<input id="s" name="s" class="text" size="10" tabindex="1" type="text">
						<input class="button" value="ok" tabindex="2" type="submit">
					</div>
				</form>
			
			</li>		</ul>
	</div><!-- #primary .sidebar -->

	<div id="secondary" class="sidebar">
	</div><!-- #secondary .sidebar -->

	<div id="footer">
		<span id="generator-link"><a href="http://wordpress.com/" rel="generator">Blog at WordPress.com</a>.</span>
		<span class="meta-sep">|</span>
		<span id="theme-link">Theme: <a href="http://www.plaintxt.org/themes/sandbox/" rel="designer">Sandbox 1.6.1</a>.</span>
	</div><!-- #footer -->

</div><!-- #wrapper .hfeed -->

<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script type="text/javascript">_qoptions={qacct:'p-18-mFEk4J448M',labels:'language.en,type.wpcom'};</script>
<script type="text/javascript" src="index_files/quant.js"></script>
<noscript><p><img class="robots-nocontent" src="http://pixel.quantserve.com/pixel/p-18-mFEk4J448M.gif?labels=language.en%2Ctype.wpcom" style="display:none" height="1" width="1" alt="" /></p></noscript>
<script type="text/javascript" src="index_files/gprofiles.js"></script>
	<script type="text/javascript">	
	// <![CDATA[
	WPGroHo = {
		data: {},
		renderers: {},
		syncProfileData: function( hash, id ) {
			if ( !WPGroHo.data[hash] ) {
				WPGroHo.data[hash] = {};
				a = jQuery( 'div.grofile-hash-map-' + hash + ' span' ).each( function() {
					WPGroHo.data[hash][this.className] = jQuery( this ).text();
				} );
			}

			WPGroHo.appendProfileData( WPGroHo.data[hash], hash, id );
		},
		appendProfileData: function( data, hash, id ) {
			for ( var key in data ) {
				if ( jQuery.isFunction( WPGroHo.renderers[key] ) ) {
					return WPGroHo.renderers[key]( data[key], hash, id, key );
				}

				jQuery( '#' + id ).find( 'h4' ).after( jQuery( '<p class="grav-extra ' + key + '" />' ).html( data[key] ) );
			}
		}
	};
	jQuery(document).ready(function($){
		Gravatar.profile_cb = function( h, d ) {
			WPGroHo.syncProfileData( h, d );
		};
		Gravatar.attach_profiles();
	});
	// ]]>
	</script>
	<div style="display: none;">
	</div>
<script type="text/javascript" src="index_files/beacon.js"></script><script type="text/javascript">try{COMSCORE.beacon({c1:2,c2:7518284});}catch(e){}</script><noscript><p class="robots-nocontent"><img src="http://b.scorecardresearch.com/p?cj=1c1=2&#038;c2=7518284" alt="" style="display:none" width="1" height="1" /></p></noscript><script src="index_files/w.js" type="text/javascript"></script>
<script type="text/javascript">
st_go({'blog':'18067431','v':'wpcom','user_id':'0','post':'0','subd':'evanweaver'});
ex_go({'crypt':'RDZ8LFkxbXFOeC15QSsxaTNDWXZUUnldZEdZQSw3eUp1TGxacX5ZWmY0TGp8UmErfkF0MlFLUGhtXWFaWDZSYWw/U0NFOWJfSS9dLlpkbUlNek8wVUQvelo/Nkh8X0ZMTWhpUExxdi9BLEJUNzZUNnRNTF9jY35HZkJNc1R+dG1rV2JBNzJKaWtQK25UN3cxfnM3eW11Q0U4cT00V3cvNVdNRU1rZnEwUWxINVU4MDBaSDJDR0hHeXh0ZTJFQmcyNUU/cG9uY1A0NHxBRFJRYnVSYjV3MXE4Zk1NJQ=='});
addLoadEvent(function(){linktracker_init('18067431',0);});
	</script><img id="wpstats" src="index_files/g_002.gif" alt=""><img id="wpstats2" src="index_files/g.gif" alt="" style="display: none;">

</body></html>